<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    .invalid-feedback { display: block; }
    .edit-btn { margin-top: 0; }
    .row > .col-3 {
      display: flex;
      align-items: center;    /* vertical center */
      justify-content: center; /* horizontal center */
    }
  </style>
</head>
<body class="container py-5">
  <h2 class="mb-4 text-center">Your Profile</h2>

  <div id="alertBox" class="alert d-none" role="alert"></div>

  <div id="profileCard" class="card p-4 mx-auto" style="max-width:600px;">
    <div id="profileContent"></div>
  </div>

<script>
$(document).ready(function() {
  const token = localStorage.getItem('auth_token');
  if (!token) {
    window.location.href = '../html/login.html';
    return;
  }

  function escapeHtml(str) {
    return String(str ?? '').replace(/&/g, "&amp;")
                            .replace(/</g, "&lt;")
                            .replace(/>/g, "&gt;")
                            .replace(/"/g, "&quot;")
                            .replace(/'/g, "&#039;");
  }

  function showAlert(message, type='danger') {
    $('#alertBox').removeClass('d-none alert-success alert-danger')
                  .addClass('alert-' + type)
                  .text(message);
  }

  function calculateAge(dobStr) {
    if (!dobStr) return '';
    const today = new Date();
    const dob = new Date(dobStr);
    let age = today.getFullYear() - dob.getFullYear();
    const m = today.getMonth() - dob.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
      age--;
    }
    return age;
  }

  function toggleUpdateButton() {
    const nameValid = $('#username').val().trim().length >= 2;
    const emailValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test($('#email').val().trim());
    const editing = !$('#username').prop('disabled') || !$('#email').prop('disabled');
    $('#Update').prop('disabled', editing || !(nameValid && emailValid));
  }

  // Fetch profile data
  $.ajax({
    url: '../php/api/profile.php',
    type: 'GET',
    dataType: 'json',
    headers: { 'Authorization': 'Bearer ' + token },
    success: function(res) {
      if (res.success) {
        const u = res.user;
        $('#profileContent').html(`
          <div class="mb-3 row">
            <div class="col-9">
              <label>Name :</label>
              <input id="username" value="${escapeHtml(u.name)}" type="text" class="form-control" disabled required>
              <div class="invalid-feedback" id="nameError"></div>
            </div>
            <div class="col-3">
              <button class="btn btn-secondary edit-btn" id="editName">Edit</button>
            </div>
          </div>

          <div class="mb-3 row">
            <div class="col-9">
              <label>Email :</label>
              <input id="email" value="${escapeHtml(u.email)}" type="email" class="form-control" disabled required>
              <div class="invalid-feedback" id="emailError"></div>
            </div>
            <div class="col-3">
              <button class="btn btn-secondary edit-btn" id="editEmail">Edit</button>
            </div>
          </div>

          <div class="mb-3">
            <label>Age :</label>
            <input id="age" value="${calculateAge(u.dob)}" type="number" class="form-control" readonly>
          </div>

          <div class="mb-3">
            <label>Date of Birth :</label>
            <input id="dob" value="${escapeHtml(u.dob)}" type="date" class="form-control">
          </div>

          <div class="mb-3">
            <label>Phone :</label>
            <input id="contact" value="${escapeHtml(u.contact)}" type="text" class="form-control">
            <div class="invalid-feedback" id="contactError"></div>
          </div>
          <div class="d-flex gap-2 mt-3">
            <button class="btn btn-primary" id="Update" disabled>Update</button>
            <button class="btn btn-danger" id="logoutBtn">Logout</button>
          </div>
        `);

        $('#username, #email').trigger('input'); // validate pre-filled data
      } else {
        showAlert('Session expired. Please login again.');
        localStorage.removeItem('auth_token');
        window.location.href = '../html/login.html';
      }
    },
    error: function() {
      showAlert('Failed to fetch profile. Please try again.');
    }
  });

  // Edit / Save toggle for Name
  $(document).on('click', '#editName', function() {
    const input = $('#username');
    if (input.prop('disabled')) {
      input.prop('disabled', false).focus();
      $(this).text('Save').removeClass('btn-secondary').addClass('btn-success');
    } else {
      input.prop('disabled', true);
      $(this).text('Edit').removeClass('btn-success').addClass('btn-secondary');
    }
    toggleUpdateButton();
  });

  // Edit / Save toggle for Email
  $(document).on('click', '#editEmail', function() {
    const input = $('#email');
    if (input.prop('disabled')) {
      input.prop('disabled', false).focus();
      $(this).text('Save').removeClass('btn-secondary').addClass('btn-success');
    } else {
      input.prop('disabled', true);
      $(this).text('Edit').removeClass('btn-success').addClass('btn-secondary');
    }
    toggleUpdateButton();
  });

  // Real-time validation
  $(document).on('input', '#username', function() {
    const valid = $(this).val().trim().length >= 2;
    $('#nameError').text(valid ? '' : 'Name must be at least 2 characters');
    toggleUpdateButton();
  });

  $(document).on('input', '#email', function() {
    const valid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test($(this).val().trim());
    $('#emailError').text(valid ? '' : 'Invalid email format');
    toggleUpdateButton();
  });

  $(document).on('input', '#contact', function() {
    const val = $(this).val().trim();
    const valid = val === '' || /^\d{7,15}$/.test(val);
    $('#contactError').text(valid ? '' : 'Phone must be 7-15 digits');
  });

  // Auto-calculate age from DOB
  $(document).on('input change', '#dob', function() {
    $('#age').val(calculateAge($(this).val()));
  });

  // Enter key triggers Update
  $('#profileCard').on('keypress', 'input', function(e) {
    if(e.which === 13) $('#Update').click();
  });

  // Update profile
  $(document).on('click', '#Update', function(e) {
    e.preventDefault();
    const formData = {
      name: $('#username').val().trim(),
      email: $('#email').val().trim(),
      age: $('#age').val() || null,
      dob: $('#dob').val() || null,
      contact: $('#contact').val().trim() || null
    };

    const btn = $(this);
    btn.prop('disabled', true).text('Updating...');
    $('#profileCard input').prop('disabled', false); // Enable inputs for submit
    $('.edit-btn').prop('disabled', true);           // Disable edit buttons during update

    $.ajax({
      url: '../php/db/mongo.php',
      type: 'POST',
      contentType: 'application/json',
      dataType: 'json',
      headers: { 'Authorization': 'Bearer ' + token },
      data: JSON.stringify(formData),
      success: function(res) {
        if (res.success) {
          showAlert('Profile updated successfully!', 'success');
        } else {
          showAlert('Update failed: ' + res.message);
        }
      },
      error: function() {
        showAlert('Server error while updating profile.');
      },
      complete: function() {
        btn.prop('disabled', false).text('Update');
        $('.edit-btn').prop('disabled', false);
        toggleUpdateButton();
      }
    });
  });
});
$(document).on('click', '#logoutBtn', function() {
  if (confirm("Are you sure you want to logout?")) {
    localStorage.removeItem('auth_token');
    window.location.href = '../html/login.html';
  }
});
</script>
</body>
</html>
